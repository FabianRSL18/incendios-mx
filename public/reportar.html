<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reportar Incendio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: #f5f5f5;
        }
        form {
            max-width: 500px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        input, textarea, button {
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <h2>Reportar posible incendio forestal</h2>
    <form id="reporteForm" enctype="multipart/form-data">
        <textarea name="descripcion" id="descripcion" placeholder="Describe lo que viste..." required></textarea>
        <input type="file" name="imagen" id="imagen" accept="image/*">
        <input type="hidden" name="lat" id="latitud">
        <input type="hidden" name="lng" id="longitud">
        <input type="hidden" id="estado" name="estado">
        <input type="hidden" id="municipio" name="municipio">
        <button type="submit">Enviar Reporte</button>
    </form>

    <script>
        // Ejecuta el c√≥digo cuando se haya cargado completamente la p√°gina
        window.onload = function () {
            // Verifica si el navegador soporta geolocalizaci√≥n
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    async function (position) {
                        // Obtiene las coordenadas actuales del usuario
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Asigna latitud y longitud a los campos ocultos del formulario
                        document.getElementById('latitud').value = lat;
                        document.getElementById('longitud').value = lng;
                        console.log('üìç Coordenadas listas:', lat, lng);

                        // Realiza Reverse Geocoding con Nominatim para obtener estado y municipio
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=es`);
                            const data = await response.json();

                            // Extrae el estado y el municipio del objeto de direcci√≥n
                            const estado = data.address.state || '';
                            const municipio = data.address.city || data.address.town || data.address.village || data.address.county || '';

                            // Llena los campos de estado y municipio autom√°ticamente
                            document.getElementById('estado').value = estado;
                            document.getElementById('municipio').value = municipio;

                            console.log('üìå Estado:', estado, '| Municipio:', municipio);
                        } catch (err) {
                            console.warn("‚ö†Ô∏è No se pudo obtener estado y municipio:", err);
                        }
                    },
                    function (error) {
                        alert("Error al obtener ubicaci√≥n: " + error.message);
                    }
                );
            } else {
                alert("Tu navegador no soporta geolocalizaci√≥n.");
            }
        };

        // Manejador del env√≠o del formulario de reporte
        document.getElementById('reporteForm').addEventListener('submit', async function (e) {
            e.preventDefault(); // Evita que el formulario se env√≠e de forma tradicional

            // Captura los valores ingresados
            const descripcion = document.getElementById('descripcion').value.trim();
            const lat = document.getElementById('latitud').value;
            const lng = document.getElementById('longitud').value;

            // Validaci√≥n b√°sica de los campos requeridos
            if (!descripcion || descripcion.length < 10) {
                alert("Por favor describe el incendio con al menos 10 caracteres.");
                return;
            }

            if (!lat || !lng) {
                alert("Ubicaci√≥n no disponible. Intenta de nuevo.");
                return;
            }

            // Desactiva el bot√≥n de env√≠o para evitar m√∫ltiples env√≠os
            const boton = this.querySelector('button[type="submit"]');
            boton.disabled = true;
            boton.textContent = "Enviando...";

            // Prepara los datos del formulario para enviar con multipart/form-data
            const formData = new FormData(this);

            try {
                // Enviar los datos del reporte a la API del servidor
                const response = await fetch('/api/reportar', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                console.log('‚úÖ Reporte enviado:', data);
                alert("Gracias por tu reporte.");
                this.reset(); // Limpia el formulario despu√©s del env√≠o
            } catch (error) {
                console.error('‚ùå Error al enviar reporte:', error);
                alert("Hubo un problema al enviar el reporte.");
            } finally {
                // Restaura el bot√≥n de env√≠o
                boton.disabled = false;
                boton.textContent = "Enviar Reporte";
            }
        });
    </script>
</body>
</html>